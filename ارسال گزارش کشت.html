<!DOCTYPE html>
<html lang="fa" dir="rtl">
    <link rel="manifest" href="manifest.json">

    <script>
      // 1019191114 12141217 Service Worker 1719 191912191519
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('Service Worker registered! Scope:', registration.scope);
            })
            .catch(err => {
              console.log('Service Worker registration failed:', err);
            });
        });
      }
    </script>
</head>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倬 孬亘鬲 诏夭丕乇卮 乇夭丕 讴卮丕乇夭</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        .persian-input {
            direction: rtl;
            text-align: right;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-1px);
        }
        
        .form-container {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid #cbd5e1;
        }
        
        .input-field {
            background: white;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.open {
            right: 0;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- 丕毓丕 -->
    <div id="toast" class="toast bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <span id="toastMessage">毓丕鬲 亘丕 鬲 丕噩丕 卮丿</span>
    </div>

    <!-- 氐丨 乇丿 -->
    <div id="loginPage" class="login-container min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">乇丿 亘 爻丕丕</h1>
                <p class="text-gray-600">丕丨丿 卮讴乇 丕丕 禺 (乇)</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 丕  丕 禺丕丕丿诏</label>
                    <input type="text" id="fullName" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="丕 讴丕 禺丿 乇丕 丕乇丿 讴丿" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 卮丕乇 讴丕乇鬲 倬乇爻</label>
                    <input type="text" id="employeeId" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="卮丕乇 讴丕乇鬲 倬乇爻" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 乇夭 乇丿</label>
                    <input type="password" id="password" class="input-field w-full px-4 py-3 rounded-lg" placeholder="乇夭 乇丿 乇丕 丕乇丿 讴丿" required>
                </div>
                
                <button type="submit" class="btn-primary w-full py-3 text-white font-medium rounded-lg">
                     乇丿 亘 爻丕丕
                </button>
            </form>
        </div>
    </div>

    <!-- 丕乇  -->
    <div id="overlay" class="overlay" onclick="closeSidebar()"></div>

    <!--  讴丕乇 -->
    <div id="sidebar" class="sidebar">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800"></h2>
                <button onclick="closeSidebar()" class="text-gray-500 hover:text-gray-700">17</button>
            </div>
        </div>
        
        <div class="p-4">
            <div class="space-y-2">
                <button onclick="showUserInfo()" class="w-full text-right px-4 py-3 rounded-lg hover:bg-gray-100 flex items-center">
                     卮禺氐丕鬲 讴丕乇亘乇
                </button>
                <button onclick="showPerformance()" class="w-full text-right px-4 py-3 rounded-lg hover:bg-gray-100 flex items-center">
                     倬丕卮 毓讴乇丿
                </button>
                <button onclick="showBackup()" class="w-full text-right px-4 py-3 rounded-lg hover:bg-gray-100 flex items-center">
                     亘讴丕倬  亘丕夭丕亘
                </button>
                <button onclick="showSupport()" class="w-full text-right px-4 py-3 rounded-lg hover:bg-blue-100 text-blue-600 flex items-center">
                     倬卮鬲亘丕
                </button>
                <button onclick="logout()" class="w-full text-right px-4 py-3 rounded-lg hover:bg-red-100 text-red-600 flex items-center">
                     禺乇噩
                </button>
            </div>
        </div>
    </div>

    <!-- 氐丨 丕氐 -->
    <div id="mainPage" class="hidden">
        <div class="container mx-auto px-4 py-6 max-w-md">
            <!-- 丿乇 -->
            <div class="text-center mb-6 bg-white rounded-2xl shadow-lg p-6 border-t-4 border-green-500 relative">
                <!-- 丿讴  -->
                <button onclick="openSidebar()" class="absolute top-4 right-4 p-2 rounded-lg hover:bg-gray-100">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                

            <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-700 to-green-900 mb-3 tracking-wide drop-shadow-lg">孬亘鬲 诏夭丕乇卮 乇夭丕 讴卮鬲 卮讴乇</h1>
            <p class="text-gray-600 text-sm font-medium">丕丨丿 卮讴乇 丕丕 禺 (乇)</p>
            <div class="mt-3 flex items-center justify-between">
                <div class="text-xs text-gray-500">爻丕丕 丿乇鬲 诏夭丕乇卮丕17 讴卮丕乇夭</div>
                <div id="cloudStatus" class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-600">
                    锔 丌丕
                </div>
            </div>
        </div>

        <!-- 乇 -->
        <div class="form-container rounded-2xl p-6 shadow-lg mb-6">
            <form id="dailyReportForm" class="space-y-4">
                <!-- 丕丿丕乇 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 丕丿丕乇</label>
                    <select id="office" class="input-field w-full px-4 py-3 rounded-lg persian-input" required>
                        <option value="">丕鬲禺丕亘 讴丿</option>
                        <option value="丕">丕</option>
                        <option value="丿">丿</option>
                        <option value="爻">爻</option>
                        <option value="丕乇">丕乇</option>
                    </select>
                </div>

                <!-- 毓 讴卮鬲 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 毓 讴卮鬲</label>
                    <select id="cultivationType" class="input-field w-full px-4 py-3 rounded-lg persian-input" required onchange="toggleContractorName()">
                        <option value="">丕鬲禺丕亘 讴丿</option>
                        <option value="倬鬲乇">倬鬲乇</option>
                        <option value="丿爻鬲">丿爻鬲</option>
                    </select>
                </div>

                <!-- 丕 倬丕讴丕乇 讴卮鬲 -->
                <div id="contractorNameContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 丕 倬丕讴丕乇 讴卮鬲</label>
                    <input type="text" id="contractorName" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="丕 倬丕讴丕乇 讴卮鬲 乇丕 丕乇丿 讴丿">
                </div>

                <!-- 毓 丕乇鬲 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">К 毓 丕乇鬲</label>
                    <select id="varietyType" class="input-field w-full px-4 py-3 rounded-lg persian-input" required onchange="toggleVarietyType()">
                        <option value="">丕鬲禺丕亘 讴丿</option>
                        <option value="CP69-1062">CP69-1062</option>
                        <option value="CP57-614">CP57-614</option>
                        <option value="CP73-21">CP73-21</option>
                        <option value="CP48-103">CP48-103</option>
                        <option value="IRC-00-14">IRC-00-14</option>
                        <option value="IRC-99-07">IRC-99-07</option>
                        <option value="丿诏乇">丿诏乇</option>
                    </select>
                </div>

                <!-- 丕 丕乇鬲 丿诏乇 -->
                <div id="otherVarietyContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 丕 丕乇鬲</label>
                    <input type="text" id="otherVarietyName" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="丕 丕乇鬲 乇丕 丕乇丿 讴丿">
                </div>



                <!-- 丕 讴丕丕 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 丕 讴丕丕</label>
                    <input type="text" id="canalName" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="丕 讴丕丕 乇丕 丕乇丿 讴丿" required>
                </div>

                <!-- 毓鬲 夭乇毓 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 毓鬲 夭乇毓</label>
                    <input type="text" id="farmLocation" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="毓鬲 夭乇毓 乇丕 丕乇丿 讴丿" required>
                </div>

                <!-- 爻丕毓鬲 卮乇毓 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 爻丕毓鬲 卮乇毓 毓丕鬲</label>
                    <input type="time" id="startTime" class="input-field w-full px-4 py-3 rounded-lg" required>
                </div>

                <!-- 爻丕毓鬲 倬丕丕 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 爻丕毓鬲 倬丕丕 毓丕鬲</label>
                    <input type="time" id="endTime" class="input-field w-full px-4 py-3 rounded-lg" required>
                </div>

                <!-- 讴鬲丕乇 丕乇夭 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 讴鬲丕乇 讴卮鬲 卮丿 丕乇夭</label>
                    <input type="number" id="todayHectares" step="0.1" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="0.0" required>
                </div>

                <!-- 讴鬲丕乇 鬲丕 丕乇夭 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 讴鬲丕乇 讴卮鬲 卮丿 鬲丕 丕乇夭</label>
                    <input type="number" id="totalHectares" step="0.1" class="input-field w-full px-4 py-3 rounded-lg persian-input bg-gray-100" readonly>
                </div>

                <!-- 爻丕毓鬲 孬亘鬲 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">17 爻丕毓鬲 孬亘鬲 诏夭丕乇卮</label>
                    <input type="text" id="recordTime" class="input-field w-full px-4 py-3 rounded-lg bg-gray-100" readonly>
                </div>

                <!-- 鬲丕乇禺 孬亘鬲 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 鬲丕乇禺 孬亘鬲 诏夭丕乇卮</label>
                    <input type="text" id="recordDate" class="input-field w-full px-4 py-3 rounded-lg bg-gray-100 persian-input" readonly>
                </div>

                <!-- 亘禺卮 丿爻鬲诏丕 鬲 -->
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 space-y-4">
                    <h3 class="text-lg font-bold text-red-700 mb-4">锔 丕胤丕毓丕鬲 丿爻鬲诏丕 鬲</h3>
                    
                    <!-- 丕鬲禺丕亘 丿爻鬲诏丕 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"> 丕鬲禺丕亘 丿爻鬲诏丕</label>
                        <select id="stoppedMachine" class="input-field w-full px-4 py-3 rounded-lg persian-input" onchange="toggleStoppedMachineDetails()">
                            <option value="丿丕乇丿">丿丕乇丿</option>
                            <option value="倬鬲乇 讴 乇丿 卮丕乇 1">倬鬲乇 讴 乇丿 卮丕乇 1</option>
                            <option value="倬鬲乇 讴 乇丿 卮丕乇 2">倬鬲乇 讴 乇丿 卮丕乇 2</option>
                            <option value="倬鬲乇 2 乇丿 卮丕乇 1">倬鬲乇 2 乇丿 卮丕乇 1</option>
                            <option value="丿诏乇">丿诏乇</option>
                        </select>
                    </div>

                    <!-- 噩夭卅丕鬲 丿爻鬲诏丕 鬲 -->
                    <div id="stoppedMachineDetails" class="hidden space-y-4">
                        <!-- 丕 丿爻鬲诏丕 丿诏乇 -->
                        <div id="otherMachineContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2"> 丕 丿爻鬲诏丕</label>
                            <input type="text" id="otherMachineName" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="丕 丿爻鬲诏丕 乇丕 丕乇丿 讴丿">
                        </div>
                        
                        <!-- 爻丕毓鬲 卮乇毓 鬲 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2"> 爻丕毓鬲 卮乇毓 鬲</label>
                            <input type="time" id="stopStartTime" class="input-field w-full px-4 py-3 rounded-lg">
                        </div>
                        
                        <!-- 爻丕毓鬲 倬丕丕 鬲 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2"> 爻丕毓鬲 倬丕丕 鬲</label>
                            <input type="time" id="stopEndTime" class="input-field w-full px-4 py-3 rounded-lg">
                        </div>
                        
                        <!-- 丿 鬲 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">17 丿 鬲</label>
                            <select id="stopReasonSelect" class="input-field w-full px-4 py-3 rounded-lg persian-input mb-3" onchange="toggleCustomStopReason()">
                                <option value="">丕鬲禺丕亘 讴丿</option>
                                <option value="禺乇丕亘 ">禺乇丕亘 </option>
                                <option value="氐 胤毓丕鬲">氐 胤毓丕鬲</option>
                                <option value="鬲毓乇  诏丿丕乇">鬲毓乇  诏丿丕乇</option>
                                <option value="讴亘丿 爻禺鬲">讴亘丿 爻禺鬲</option>
                                <option value="卮乇丕胤 丌亘  丕">卮乇丕胤 丌亘  丕</option>
                                <option value="丿诏乇">丿诏乇</option>
                            </select>
                            
                            <!-- 丿 丿 鬲 丿诏乇 -->
                            <div id="customStopReasonContainer" class="hidden">
                                <textarea id="customStopReason" rows="2" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="丿 鬲 乇丕 卮乇丨 丿丿..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 讴鬲 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> 讴鬲</label>
                    <textarea id="notes" rows="3" class="input-field w-full px-4 py-3 rounded-lg persian-input" placeholder="讴丕鬲 丕囟丕 乇丕 丕乇丿 讴丿..."></textarea>
                </div>
            </form>
        </div>

        <!-- 丿讴丕17 毓丕鬲 -->
        <div class="space-y-3">
            <button onclick="saveReport()" class="btn-primary w-full py-4 text-white font-medium rounded-xl shadow-lg">
                 匕禺乇 诏夭丕乇卮
            </button>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="loadReports()" class="py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl shadow-lg transition-all text-sm">
                     卮丕丿 诏夭丕乇卮17
                </button>
                <button onclick="syncFromCloud()" class="py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-xl shadow-lg transition-all text-sm">
                    锔 诏丕爻丕夭17 丕亘乇
                </button>
            </div>
        </div>

        <!-- 诏夭丕乇卮丕17 匕禺乇 卮丿 -->
        <div id="savedReports" class="mt-6 hidden">
            <h3 class="text-lg font-bold text-gray-800 mb-4">诏夭丕乇卮丕17 匕禺乇 卮丿</h3>
            <div id="reportsList" class="space-y-3"></div>
        </div>
        </div>
    </div>

    <!-- 氐丨丕鬲  -->
    <div id="menuPages" class="hidden">
        <!-- 卮禺氐丕鬲 讴丕乇亘乇 -->
        <div id="userInfoPage" class="hidden container mx-auto px-4 py-6 max-w-md">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">卮禺氐丕鬲 讴丕乇亘乇</h2>
                    <button onclick="backToMain()" class="text-gray-500 hover:text-gray-700">17 亘丕夭诏卮鬲</button>
                </div>
                <div id="userInfoContent" class="space-y-4"></div>
            </div>
        </div>

        <!-- 倬丕卮 毓讴乇丿 -->
        <div id="performancePage" class="hidden container mx-auto px-4 py-6 max-w-md">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">倬丕卮 毓讴乇丿</h2>
                    <button onclick="backToMain()" class="text-gray-500 hover:text-gray-700">17 亘丕夭诏卮鬲</button>
                </div>
                <div id="performanceContent" class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4 text-center"> 乇丿 讴卮鬲 讴鬲丕乇</h3>
                        <div style="height: 250px;">
                            <canvas id="hectareChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold mb-4 text-center">17 爻丕毓丕鬲 讴丕乇 乇夭丕</h3>
                        <div style="height: 250px;">
                            <canvas id="hoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 倬卮鬲亘丕 -->
        <div id="supportPage" class="hidden container mx-auto px-4 py-6 max-w-md">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">倬卮鬲亘丕 </h2>
                    <button onclick="backToMain()" class="text-gray-500 hover:text-gray-700">17 亘丕夭诏卮鬲</button>
                </div>
                
                <div class="space-y-6">
                    <!-- 丕胤丕毓丕鬲 倬卮鬲亘丕 -->
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-lg ml-4">
                                MK
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-blue-800">丨丿 讴毓亘</h3>
                                <p class="text-blue-600 text-sm">爻卅 倬卮鬲亘丕 </p>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-2xl ml-3"></span>
                                        <div>
                                            <div class="font-semibold text-gray-800">卮丕乇 鬲丕爻</div>
                                            <div class="text-blue-600 font-bold text-lg">09168231334</div>
                                        </div>
                                    </div>
                                    <button onclick="callSupport()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-all">
                                         鬲丕爻
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 爻丕毓丕鬲 讴丕乇 -->
                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                        <h4 class="font-bold text-green-800 mb-3 flex items-center">
                             爻丕毓丕鬲 倬卮鬲亘丕
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-700">卮亘 鬲丕 丕乇卮亘:</span>
                                <span class="font-medium text-green-700">8:00 - 16:00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">倬噩卮亘17:</span>
                                <span class="font-medium text-green-700">8:00 - 13:00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">噩毓:</span>
                                <span class="font-medium text-red-600">鬲毓胤</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 乇丕丕 爻乇毓 -->
                    <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 p-6 rounded-xl border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 mb-3"> 乇丕丕 爻乇毓</h4>
                        <div class="space-y-2 text-sm text-yellow-700">
                            <p>17 亘乇丕 卮讴丕鬲  亘丕 卮丕乇 亘丕丕 鬲丕爻 亘诏乇丿</p>
                            <p>17 亘 丕夭 鬲丕爻 毓 禺胤丕  倬丕 丌 乇丕 丕丿丿丕卮鬲 讴丿</p>
                            <p>17 亘乇丕 亘讴丕倬 丕胤丕毓丕鬲 丕夭  "亘讴丕倬  亘丕夭丕亘" 丕爻鬲丕丿 讴丿</p>
                            <p>17 丿乇 氐乇鬲 胤毓 丕鬲乇鬲 丕胤丕毓丕鬲 丨 匕禺乇 卮17</p>
                        </div>
                    </div>
                    

                </div>
            </div>
        </div>

        <!-- 亘讴丕倬  亘丕夭丕亘 -->
        <div id="backupPage" class="hidden container mx-auto px-4 py-6 max-w-md">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">亘讴丕倬  亘丕夭丕亘</h2>
                    <button onclick="backToMain()" class="text-gray-500 hover:text-gray-700">17 亘丕夭诏卮鬲</button>
                </div>
                
                <div class="space-y-6">
                    <!-- 丕噩丕丿 亘讴丕倬 -->
                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                        <h3 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                             丕噩丕丿 亘讴丕倬
                        </h3>
                        <p class="text-sm text-green-700 mb-4">
                            鬲丕 诏夭丕乇卮17  丕胤丕毓丕鬲 卮丕 丿乇 讴 丕 匕禺乇 卮17
                        </p>
                        <button onclick="createBackup()" class="btn-primary w-full py-3 text-white font-medium rounded-lg shadow-lg">
                             丿丕丿 丕 亘讴丕倬
                        </button>
                    </div>
                    
                    <!-- 亘丕夭丕亘 亘讴丕倬 -->
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center">
                             亘丕夭丕亘 丕胤丕毓丕鬲
                        </h3>
                        <p class="text-sm text-blue-700 mb-4">
                            丕 亘讴丕倬 亘 禺丿 乇丕 丕鬲禺丕亘 讴丿 鬲丕 丕胤丕毓丕鬲 亘丕夭丕亘 卮丿
                        </p>
                        <div class="space-y-3">
                            <input type="file" id="backupFile" accept=".json" class="input-field w-full px-4 py-3 rounded-lg border-2 border-dashed border-blue-300 bg-white">
                            <button onclick="restoreBackup()" class="btn-secondary w-full py-3 text-white font-medium rounded-lg shadow-lg">
                                 亘丕夭丕亘 丕夭 丕
                            </button>
                        </div>
                    </div>
                    
                    <!-- 丕胤丕毓丕鬲 毓 -->
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                        <h3 class="text-lg font-semibold text-purple-800 mb-3"> 丕胤丕毓丕鬲 毓</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded-lg text-center">
                                <div class="text-xl font-bold text-purple-600" id="currentReportsCount">0</div>
                                <div class="text-xs text-gray-600">诏夭丕乇卮 匕禺乇 卮丿</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg text-center">
                                <div class="text-xl font-bold text-green-600" id="currentTotalHectares">0.0</div>
                                <div class="text-xs text-gray-600">讴 讴鬲丕乇</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 卮丿丕乇 -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <div class="text-yellow-600 text-xl ml-3">锔</div>
                            <div>
                                <h4 class="text-sm font-semibold text-yellow-800">讴鬲 </h4>
                                <p class="text-xs text-yellow-700 mt-1">
                                    亘丕夭丕亘 丕胤丕毓丕鬲 鬲丕 丿丕丿丕17 毓 乇丕 噩丕诏夭 讴17. 丨鬲丕 亘 丕夭 亘丕夭丕亘 亘讴丕倬 噩丿丿 鬲 讴丿.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 鬲亘丿 鬲丕乇禺 丕丿 亘 卮爻
        function toPersianDate(date) {
            const persianMonths = [
                '乇乇丿', '丕乇丿亘卮鬲', '禺乇丿丕丿', '鬲乇', '乇丿丕丿', '卮乇乇',
                '乇', '丌亘丕', '丌匕乇', '丿', '亘', '丕爻丿'
            ];
            
            // 丕爻鬲丕丿 丕夭 讴鬲丕亘禺丕 Intl 亘乇丕 鬲亘丿 丿
            try {
                const persianDate = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(date);
                return persianDate;
            } catch (error) {
                // 乇卮 噩丕诏夭 丿乇 氐乇鬲 毓丿 倬卮鬲亘丕
                const gy = date.getFullYear();
                const gm = date.getMonth() + 1;
                const gd = date.getDate();
                
                // 丨丕爻亘 爻丕丿 鬲乇 亘乇丕 丕卮
                let jy = gy - 621;
                let jm = gm;
                let jd = gd;
                
                // 鬲馗 鬲乇亘 丕17
                if (gm <= 3) {
                    jy--;
                    jm += 9;
                } else {
                    jm -= 3;
                }
                
                // 丨丿丿 讴乇丿 丕 亘 12
                if (jm > 12) jm = 12;
                if (jm < 1) jm = 1;
                
                return `${jd} ${persianMonths[jm - 1]} ${jy}`;
            }
        }

        // 乇丕丕丿丕夭17 乇
        function initializeForm() {
            const now = new Date();
            document.getElementById('recordTime').value = now.toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'});
            document.getElementById('recordDate').value = toPersianDate(now);
            
            // 丨丕爻亘 讴 讴鬲丕乇
            calculateTotalHectares();
        }

        // 丨丕爻亘 讴 讴鬲丕乇 丕夭 诏夭丕乇卮丕17 亘
        function calculateTotalHectares() {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const total = reports.reduce((sum, report) => sum + parseFloat(report.todayHectares || 0), 0);
            const todayHectares = parseFloat(document.getElementById('todayHectares').value || 0);
            document.getElementById('totalHectares').value = (total + todayHectares).toFixed(1);
        }

        // 亘乇夭乇爻丕17 讴 讴鬲丕乇 诏丕 鬲睾乇 讴鬲丕乇 丕乇夭
        document.getElementById('todayHectares').addEventListener('input', calculateTotalHectares);

        // 讴鬲乇 丕卮 丿 丕乇鬲 丿诏乇
        function toggleVarietyType() {
            const varietyType = document.getElementById('varietyType').value;
            const otherContainer = document.getElementById('otherVarietyContainer');
            
            if (varietyType === '丿诏乇') {
                otherContainer.classList.remove('hidden');
            } else {
                otherContainer.classList.add('hidden');
            }
        }

        // 讴鬲乇 丕卮 丿 丕 倬丕讴丕乇
        function toggleContractorName() {
            const cultivationType = document.getElementById('cultivationType').value;
            const contractorContainer = document.getElementById('contractorNameContainer');
            
            if (cultivationType === '丿爻鬲') {
                contractorContainer.classList.remove('hidden');
            } else {
                contractorContainer.classList.add('hidden');
            }
        }

        // 讴鬲乇 丕卮 噩夭卅丕鬲 丿爻鬲诏丕 鬲
        function toggleStoppedMachineDetails() {
            const stoppedMachine = document.getElementById('stoppedMachine').value;
            const detailsContainer = document.getElementById('stoppedMachineDetails');
            const otherContainer = document.getElementById('otherMachineContainer');
            
            if (stoppedMachine === '丿丕乇丿') {
                detailsContainer.classList.add('hidden');
            } else {
                detailsContainer.classList.remove('hidden');
                
                if (stoppedMachine === '丿诏乇') {
                    otherContainer.classList.remove('hidden');
                } else {
                    otherContainer.classList.add('hidden');
                }
            }
        }

        // 讴鬲乇 丕卮 丿 丿 鬲 丿诏乇
        function toggleCustomStopReason() {
            const stopReasonSelect = document.getElementById('stopReasonSelect').value;
            const customContainer = document.getElementById('customStopReasonContainer');
            
            if (stopReasonSelect === '丿诏乇') {
                customContainer.classList.remove('hidden');
            } else {
                customContainer.classList.add('hidden');
            }
        }

        // 鬲馗丕鬲 爻乇乇 丕亘乇
        const CLOUD_CONFIG = {
            // 匕禺乇 诏夭丕乇卮17
            reportsBinId: '68a61658d0ea881f405e7e4e',
            // 匕禺乇 讴丕乇亘乇丕
            usersBinId: '68a9fe84ae596e708fd25e33',
            masterKey: '$2a$10$ndv0U7pxAuajXToOkZYy8OCvhOuDIGuJVsCxbt2FlvUJKondHM/LW',
            baseUrl: 'https://api.jsonbin.io/v3/b'
        };

        // 匕禺乇 丿乇 爻乇乇 丕亘乇
        async function saveToCloud(data, binId) {
            try {
                const response = await fetch(`${CLOUD_CONFIG.baseUrl}/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CLOUD_CONFIG.masterKey,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return { success: true, data: result };
            } catch (error) {
                console.error('禺胤丕 丿乇 匕禺乇 丕亘乇:', error);
                return { success: false, error: error.message };
            }
        }

        // 亘丕乇诏乇 丕夭 爻乇乇 丕亘乇
        async function loadFromCloud(binId) {
            try {
                const response = await fetch(`${CLOUD_CONFIG.baseUrl}/${binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': CLOUD_CONFIG.masterKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return { success: true, data: result.record };
            } catch (error) {
                console.error('禺胤丕 丿乇 亘丕乇诏乇 丕亘乇:', error);
                return { success: false, error: error.message };
            }
        }

        // 丿乇鬲 讴丕乇亘乇丕 丿乇 爻乇乇 丕亘乇
        async function saveUserToCloud(userData) {
            try {
                // 亘乇乇爻 氐丨鬲 丿丕丿丕17 讴丕乇亘乇
                if (!userData || !userData.employeeId || !userData.fullName) {
                    console.error('丿丕丿丕17 讴丕乇亘乇 丕氐 丕爻鬲:', userData);
                    return { success: false, error: '丿丕丿丕17 讴丕乇亘乇 丕氐 丕爻鬲' };
                }

                // 亘丕乇诏乇 讴丕乇亘乇丕 噩丿
                const existingUsersResult = await loadFromCloud(CLOUD_CONFIG.usersBinId);
                let allUsers = {};
                
                if (existingUsersResult.success && existingUsersResult.data) {
                    // 鬲乇 讴乇丿 丕丿乇 null  丕毓鬲亘乇
                    const validData = existingUsersResult.data;
                    if (typeof validData === 'object' && validData !== null) {
                        Object.keys(validData).forEach(key => {
                            if (validData[key] && typeof validData[key] === 'object' && validData[key].employeeId) {
                                allUsers[key] = validData[key];
                            }
                        });
                    }
                }
                
                // 丕囟丕 讴乇丿 丕 亘乇夭乇爻丕17 讴丕乇亘乇
                const userKey = userData.employeeId;
                allUsers[userKey] = {
                    fullName: userData.fullName,
                    employeeId: userData.employeeId,
                    loginDate: userData.loginDate || new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // 匕禺乇 丿乇 爻乇乇
                const result = await saveToCloud(allUsers, CLOUD_CONFIG.usersBinId);
                return result;
            } catch (error) {
                console.error('禺胤丕 丿乇 匕禺乇 讴丕乇亘乇:', error);
                return { success: false, error: error.message };
            }
        }

        // 亘丕乇诏乇 丕胤丕毓丕鬲 讴丕乇亘乇 丕夭 爻乇乇
        async function loadUserFromCloud(employeeId) {
            try {
                const usersResult = await loadFromCloud(CLOUD_CONFIG.usersBinId);
                
                if (usersResult.success && usersResult.data && usersResult.data[employeeId]) {
                    return { success: true, user: usersResult.data[employeeId] };
                }
                
                return { success: false, error: '讴丕乇亘乇 丕鬲 卮丿' };
            } catch (error) {
                console.error('禺胤丕 丿乇 亘丕乇诏乇 讴丕乇亘乇:', error);
                return { success: false, error: error.message };
            }
        }

        // 诏丕爻丕夭17 诏夭丕乇卮丕17 讴丕乇亘乇 亘丕 爻乇乇 丕亘乇
        async function syncUserReportsWithCloud(employeeId) {
            try {
                // 亘乇乇爻 氐丨鬲 卮丕乇 讴丕乇鬲 倬乇爻
                if (!employeeId || employeeId.trim() === '') {
                    console.error('卮丕乇 讴丕乇鬲 倬乇爻 丕毓鬲亘乇 丕爻鬲');
                    return { success: false, error: '卮丕乇 讴丕乇鬲 倬乇爻 丕毓鬲亘乇 丕爻鬲' };
                }

                // 亘丕乇诏乇 鬲丕 诏夭丕乇卮17 丕夭 爻乇乇
                const reportsResult = await loadFromCloud(CLOUD_CONFIG.reportsBinId);
                let allReports = {};
                
                if (reportsResult.success && reportsResult.data) {
                    // 鬲乇 讴乇丿 丿丕丿丕17 毓鬲亘乇
                    const validData = reportsResult.data;
                    if (typeof validData === 'object' && validData !== null) {
                        Object.keys(validData).forEach(key => {
                            if (validData[key] && Array.isArray(validData[key])) {
                                // 鬲乇 讴乇丿 诏夭丕乇卮丕17 毓鬲亘乇
                                const validReports = validData[key].filter(report => 
                                    report && 
                                    typeof report === 'object' && 
                                    report.id && 
                                    report.office &&
                                    report.todayHectares !== undefined
                                );
                                if (validReports.length > 0) {
                                    allReports[key] = validReports;
                                }
                            }
                        });
                    }
                }
                
                // 诏夭丕乇卮丕17 丨 讴丕乇亘乇 毓
                const localReports = JSON.parse(localStorage.getItem('farmReports') || '[]');
                const validLocalReports = localReports.filter(report => 
                    report && 
                    typeof report === 'object' && 
                    report.id && 
                    report.office &&
                    report.todayHectares !== undefined
                );
                
                // 丕囟丕 讴乇丿 诏夭丕乇卮丕17 丨 亘 爻乇乇
                if (!allReports[employeeId]) {
                    allReports[employeeId] = [];
                }
                
                // 丕丿睾丕 诏夭丕乇卮17 (丨匕 鬲讴乇丕乇17)
                const existingIds = allReports[employeeId].map(r => r.id);
                const newReports = validLocalReports.filter(r => !existingIds.includes(r.id));
                
                if (newReports.length > 0) {
                    allReports[employeeId] = [...allReports[employeeId], ...newReports];
                }
                
                // 匕禺乇 丿乇 爻乇乇
                const saveResult = await saveToCloud(allReports, CLOUD_CONFIG.reportsBinId);
                
                if (saveResult.success) {
                    // 亘乇夭乇爻丕17 诏夭丕乇卮丕17 丨 亘丕 诏夭丕乇卮丕17 爻乇乇
                    localStorage.setItem('farmReports', JSON.stringify(allReports[employeeId] || []));
                    return { success: true, newReports: newReports.length };
                }
                
                return saveResult;
            } catch (error) {
                console.error('禺胤丕 丿乇 诏丕爻丕夭17 诏夭丕乇卮17:', error);
                return { success: false, error: error.message };
            }
        }

        // 诏丕爻丕夭17 讴 亘丕 爻乇乇 丕亘乇
        async function syncWithCloud() {
            const localUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!localUser.employeeId) {
                return { success: false, error: '丕胤丕毓丕鬲 讴丕乇亘乇 丕鬲 卮丿' };
            }
            
            // 匕禺乇 丕胤丕毓丕鬲 讴丕乇亘乇
            const userResult = await saveUserToCloud(localUser);
            
            // 诏丕爻丕夭17 诏夭丕乇卮17
            const reportsResult = await syncUserReportsWithCloud(localUser.employeeId);
            
            return {
                success: userResult.success && reportsResult.success,
                userSaved: userResult.success,
                reportsSynced: reportsResult.success,
                newReports: reportsResult.newReports || 0
            };
        }

        // 匕禺乇 诏夭丕乇卮
        async function saveReport() {
            const form = document.getElementById('dailyReportForm');
            if (!form.checkValidity()) {
                showToast('胤丕 鬲丕 丿丕 丕夭丕 乇丕 倬乇 讴丿', 'error');
                return;
            }

            // 丕卮 丨丕鬲 亘丕乇诏匕丕乇
            const saveBtn = document.querySelector('button[onclick="saveReport()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '17 丿乇 丨丕 匕禺乇...';
            saveBtn.disabled = true;

            const stoppedMachine = document.getElementById('stoppedMachine').value;
            const otherMachineName = document.getElementById('otherMachineName').value;
            const stopReasonSelect = document.getElementById('stopReasonSelect').value;
            const customStopReason = document.getElementById('customStopReason').value;
            const varietyType = document.getElementById('varietyType').value;
            const otherVarietyName = document.getElementById('otherVarietyName').value;
            
            const report = {
                id: Date.now(),
                office: document.getElementById('office').value,
                cultivationType: document.getElementById('cultivationType').value,
                contractorName: document.getElementById('contractorName').value,
                varietyType: varietyType,
                otherVarietyName: varietyType === '丿诏乇' ? otherVarietyName : '',
                stoppedMachine: stoppedMachine,
                otherMachineName: stoppedMachine === '丿诏乇' ? otherMachineName : '',
                stopStartTime: document.getElementById('stopStartTime').value,
                stopEndTime: document.getElementById('stopEndTime').value,
                stopReason: stopReasonSelect === '丿诏乇' ? customStopReason : stopReasonSelect,
                canalName: document.getElementById('canalName').value,
                farmLocation: document.getElementById('farmLocation').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                todayHectares: document.getElementById('todayHectares').value,
                totalHectares: document.getElementById('totalHectares').value,
                recordTime: document.getElementById('recordTime').value,
                recordDate: document.getElementById('recordDate').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            // 匕禺乇 丨
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            reports.push(report);
            localStorage.setItem('farmReports', JSON.stringify(reports));

            // 匕禺乇 丿乇 爻乇乇 丕亘乇
            const cloudResult = await syncWithCloud();
            
            // 亘丕夭诏乇丿丕 丿讴
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

            if (cloudResult.success) {
                showToast('17 诏夭丕乇卮 丿乇 爻乇乇 丕亘乇 匕禺乇 卮丿');
            } else {
                showToast('锔 诏夭丕乇卮 丨 匕禺乇 卮丿 - 禺胤丕 丿乇 匕禺乇 丕亘乇', 'error');
            }

            form.reset();
            initializeForm();
        }





        // 诏丕爻丕夭17 丕夭 爻乇乇 丕亘乇
        async function syncFromCloud() {
            const syncBtn = document.querySelector('button[onclick="syncFromCloud()"]');
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = '17 丿乇 丨丕 诏丕爻丕夭17...';
            syncBtn.disabled = true;

            try {
                const localUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                if (!localUser.employeeId) {
                    showToast('17 丕亘鬲丿丕 丕乇丿 爻爻鬲 卮丿', 'error');
                    return;
                }

                // 诏丕爻丕夭17 诏夭丕乇卮丕17 讴丕乇亘乇
                const result = await syncUserReportsWithCloud(localUser.employeeId);
                
                if (result.success) {
                    calculateTotalHectares();
                    
                    if (result.newReports > 0) {
                        showToast(`17 ${result.newReports} 诏夭丕乇卮 噩丿丿 丕夭 爻乇乇 丿乇丕鬲 卮丿`);
                    } else {
                        showToast('17 丕胤丕毓丕鬲 亘乇17 丕爻鬲 - 鬲睾乇 丕鬲');
                    }
                } else {
                    showToast('17 禺胤丕 丿乇 诏丕爻丕夭17 亘丕 爻乇乇', 'error');
                }
            } catch (error) {
                console.error('禺胤丕 丿乇 诏丕爻丕夭17:', error);
                showToast('17 禺胤丕 丿乇 诏丕爻丕夭17 亘丕 爻乇乇', 'error');
            } finally {
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }

        // 亘丕乇诏匕丕乇  丕卮 诏夭丕乇卮17
        function loadReports() {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const container = document.getElementById('savedReports');
            const list = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                showToast(' 诏夭丕乇卮 匕禺乇 卮丿 丕爻鬲', 'error');
                return;
            }

            list.innerHTML = '';
            reports.reverse().forEach(report => {
                // 丨丕爻亘 爻丕毓丕鬲 讴丕乇
                let workHours = '丕卮禺氐';
                if (report.startTime && report.endTime) {
                    try {
                        const start = new Date(`2000-01-01 ${report.startTime}`);
                        const end = new Date(`2000-01-01 ${report.endTime}`);
                        let hours = (end - start) / (1000 * 60 * 60);
                        if (hours < 0) hours += 24;
                        workHours = `${Math.round(hours * 10) / 10} 爻丕毓鬲`;
                    } catch (error) {
                        workHours = '丕卮禺氐';
                    }
                }
                
                // 丕胤丕毓丕鬲 丿爻鬲诏丕 鬲
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const reporterName = user.fullName || '丕卮禺氐';
                
                let machineInfo = '丿丕乇丿';
                if (report.stoppedMachine && report.stoppedMachine !== '丿丕乇丿') {
                    const machineName = report.stoppedMachine === '丿诏乇' ? report.otherMachineName : report.stoppedMachine;
                    const stopDuration = calculateStopDuration(report.stopStartTime, report.stopEndTime);
                    machineInfo = `${machineName} (${stopDuration})`;
                }
                
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg shadow border-r-4 border-green-500';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-bold text-gray-800 text-lg"> ${reporterName}</h4>
                        <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                            卮丕爻: ${report.id}
                        </div>
                    </div>
                    <div class="space-y-2 text-sm mb-4">
                        <p class="text-gray-700"><span class="font-medium"> 卮丕乇 讴丕乇鬲:</span> ${user.employeeId || '丕卮禺氐'}</p>
                        <p class="text-gray-700"><span class="font-medium"> 丕丿丕乇:</span> ${report.office}</p>
                        <p class="text-gray-700"><span class="font-medium"> 毓 讴卮鬲:</span> ${report.cultivationType}</p>
                        ${report.contractorName ? `<p class="text-gray-700"><span class="font-medium"> 倬丕讴丕乇:</span> ${report.contractorName}</p>` : ''}
                        <p class="text-gray-700"><span class="font-medium">К 丕乇鬲:</span> ${report.varietyType === '丿诏乇' ? report.otherVarietyName : report.varietyType}</p>
                        <p class="text-gray-700"><span class="font-medium"> 讴丕丕:</span> ${report.canalName}</p>
                        <p class="text-gray-700"><span class="font-medium"> 夭乇毓:</span> ${report.farmLocation}</p>
                        <p class="text-gray-700"><span class="font-medium">17 爻丕毓鬲 讴丕乇:</span> ${report.startTime} 鬲丕 ${report.endTime}</p>
                        <p class="text-gray-700"><span class="font-medium">锔 丿爻鬲诏丕 鬲:</span> ${machineInfo}</p>
                        <p class="text-blue-600 font-medium"><span class="font-medium"> 丿鬲 讴丕乇:</span> ${workHours}</p>
                        <p class="text-green-600 font-medium"><span class="font-medium"> 讴鬲丕乇 丕乇夭:</span> ${report.todayHectares}</p>
                        <p class="text-green-600 font-medium"><span class="font-medium"> 讴鬲丕乇 鬲丕 丕乇夭:</span> ${report.totalHectares}</p>
                        <p class="text-gray-600 font-medium"><span class="font-medium"> 孬亘鬲:</span> ${report.recordDate} - ${report.recordTime}</p>
                    </div>
                    <div class="flex gap-2 pt-3 border-t border-gray-200">
                        <button onclick="copyReportText(${report.id})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-all">
                             讴倬 鬲
                        </button>
                        <button onclick="downloadSingleReportExcel(${report.id})" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-all">
                             丿丕丿 丕讴爻
                        </button>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="editReport(${report.id})" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-all">
                            锔 乇丕卮
                        </button>
                        <button onclick="deleteReport(${report.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-medium transition-all">
                            锔17 丨匕
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
            
            container.classList.remove('hidden');
        }

        // 丨丕爻亘 丿鬲 鬲 丿爻鬲诏丕
        function calculateStopDuration(startTime, endTime) {
            if (!startTime || !endTime) return '丕卮禺氐';
            
            try {
                const start = new Date(`2000-01-01 ${startTime}`);
                const end = new Date(`2000-01-01 ${endTime}`);
                let hours = (end - start) / (1000 * 60 * 60);
                
                if (hours < 0) hours += 24;
                
                const wholeHours = Math.floor(hours);
                const minutes = Math.round((hours - wholeHours) * 60);
                
                if (wholeHours === 0) {
                    return `${minutes} 丿`;
                } else if (minutes === 0) {
                    return `${wholeHours} 爻丕毓鬲`;
                } else {
                    return `${wholeHours} 爻丕毓鬲  ${minutes} 丿`;
                }
            } catch (error) {
                return '丕卮禺氐';
            }
        }



        // 丨匕 诏夭丕乇卮
        function deleteReport(id) {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const report = reports.find(r => r.id === id);
            
            if (!report) {
                showToast('诏夭丕乇卮 丕鬲 卮丿', 'error');
                return;
            }
            
            const confirmMessage = `丌丕 胤卅 爻鬲丿 讴 禺丕17 丕 诏夭丕乇卮 乇丕 丨匕 讴丿\n\n` +
                ` 鬲丕乇禺: ${report.recordDate}\n` +
                ` 丕丿丕乇: ${report.office}\n` +
                ` 讴鬲丕乇: ${report.todayHectares}\n\n` +
                `丕 毓 丕亘 亘丕夭诏卮鬲 爻鬲!`;
            
            if (confirm(confirmMessage)) {
                const filtered = reports.filter(r => r.id !== id);
                localStorage.setItem('farmReports', JSON.stringify(filtered));
                loadReports();
                calculateTotalHectares();
                showToast('诏夭丕乇卮 亘丕 鬲 丨匕 卮丿');
            }
        }

        // 乇丕卮 诏夭丕乇卮
        function editReport(id) {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const report = reports.find(r => r.id === id);
            
            if (!report) {
                showToast('诏夭丕乇卮 丕鬲 卮丿', 'error');
                return;
            }
            
            // 倬乇 讴乇丿 乇 亘丕 丕胤丕毓丕鬲 诏夭丕乇卮
            document.getElementById('office').value = report.office || '';
            document.getElementById('cultivationType').value = report.cultivationType || '';
            document.getElementById('contractorName').value = report.contractorName || '';
            document.getElementById('varietyType').value = report.varietyType || '';
            document.getElementById('otherVarietyName').value = report.otherVarietyName || '';
            document.getElementById('stoppedMachine').value = report.stoppedMachine || '丿丕乇丿';
            document.getElementById('otherMachineName').value = report.otherMachineName || '';
            document.getElementById('stopStartTime').value = report.stopStartTime || '';
            document.getElementById('stopEndTime').value = report.stopEndTime || '';
            document.getElementById('stopReasonSelect').value = report.stopReason || '';
            document.getElementById('customStopReason').value = report.stopReason || '';
            document.getElementById('canalName').value = report.canalName || '';
            document.getElementById('farmLocation').value = report.farmLocation || '';
            document.getElementById('startTime').value = report.startTime || '';
            document.getElementById('endTime').value = report.endTime || '';
            document.getElementById('todayHectares').value = report.todayHectares || '';
            document.getElementById('notes').value = report.notes || '';
            
            // 毓丕 讴乇丿 丿丕 卮乇胤
            toggleContractorName();
            toggleVarietyType();
            toggleStoppedMachineDetails();
            toggleCustomStopReason();
            
            // 丨匕 诏夭丕乇卮 丿
            deleteReport(id);
            
            // 亘丕夭诏卮鬲 亘 氐丨 丕氐
            backToMain();
            
            // 丕卮 倬丕
            showToast('诏夭丕乇卮 亘乇丕 乇丕卮 亘丕乇诏匕丕乇 卮丿 - 鬲睾乇丕鬲 乇丕 丕毓丕 讴丿  噩丿丿丕 匕禺乇 讴丿');
            
            // 丕爻讴乇 亘 亘丕丕 氐丨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 讴倬 鬲 诏夭丕乇卮 乇丿
        function copyReportText(id) {
            try {
                const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
                const report = reports.find(r => r.id === id);
                
                if (!report) {
                    showToast('诏夭丕乇卮 丕鬲 卮丿', 'error');
                    return;
                }
                
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const reporterName = user.fullName || '丕卮禺氐';
                
                // 丨丕爻亘 爻丕毓丕鬲 讴丕乇
                let workHours = '丕卮禺氐';
                if (report.startTime && report.endTime) {
                    try {
                        const start = new Date(`2000-01-01 ${report.startTime}`);
                        const end = new Date(`2000-01-01 ${report.endTime}`);
                        let hours = (end - start) / (1000 * 60 * 60);
                        if (hours < 0) hours += 24;
                        workHours = `${Math.round(hours * 10) / 10} 爻丕毓鬲`;
                    } catch (error) {
                        workHours = '丕卮禺氐';
                    }
                }
                
                // 丕胤丕毓丕鬲 丿爻鬲诏丕 鬲
                let machineInfo = '丿丕乇丿';
                if (report.stoppedMachine && report.stoppedMachine !== '丿丕乇丿') {
                    const machineName = report.stoppedMachine === '丿诏乇' ? report.otherMachineName : report.stoppedMachine;
                    const stopDuration = calculateStopDuration(report.stopStartTime, report.stopEndTime);
                    machineInfo = `${machineName} (丿鬲 鬲: ${stopDuration})`;
                    if (report.stopReason) {
                        machineInfo += ` - 丿: ${report.stopReason}`;
                    }
                }
                
                const text = `诏夭丕乇卮 乇夭丕 讴卮鬲 卮讴乇
 诏夭丕乇卮 丿丿: ${reporterName}
 丕丿丕乇: ${report.office}
 毓 讴卮鬲: ${report.cultivationType}${report.contractorName ? `\n 倬丕讴丕乇 讴卮鬲: ${report.contractorName}` : ''}
К 毓 丕乇鬲: ${report.varietyType === '丿诏乇' ? report.otherVarietyName : report.varietyType}
 讴丕丕: ${report.canalName}
 夭乇毓: ${report.farmLocation}
17 爻丕毓鬲 卮乇毓/倬丕丕: ${report.startTime} 鬲丕 ${report.endTime}
锔 丕胤丕毓丕鬲 丿爻鬲诏丕 鬲: ${machineInfo}
 鬲毓丿丕丿 爻丕毓鬲 讴丕乇: ${workHours}
 鬲丕乇禺/爻丕毓鬲 孬亘鬲: ${report.recordDate} - ${report.recordTime}
 讴鬲丕乇 丕乇夭: ${report.todayHectares}
 讴鬲丕乇 鬲丕 丕乇夭: ${report.totalHectares}
 讴鬲: ${report.notes || '丿丕乇丿'}`;
                
                // 讴倬 鬲
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('鬲 诏夭丕乇卮 讴倬 卮丿');
                    }).catch((error) => {
                        console.error('禺胤丕 丿乇 讴倬:', error);
                        fallbackCopyTextToClipboard(text);
                    });
                } else {
                    fallbackCopyTextToClipboard(text);
                }
            } catch (error) {
                console.error('禺胤丕 丿乇 讴倬 鬲 诏夭丕乇卮:', error);
                showToast('禺胤丕 丿乇 讴倬 讴乇丿 鬲', 'error');
            }
        }

        // 乇卮 噩丕诏夭 讴倬
        function fallbackCopyTextToClipboard(text) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showToast('鬲 诏夭丕乇卮 讴倬 卮丿');
                } else {
                    showToast('禺胤丕 丿乇 讴倬 讴乇丿 鬲', 'error');
                }
            } catch (error) {
                console.error('禺胤丕 丿乇 乇卮 噩丕诏夭 讴倬:', error);
                showToast('禺胤丕 丿乇 讴倬 讴乇丿 鬲', 'error');
            }
        }

        // 丿丕丿 丕讴爻 诏夭丕乇卮 乇丿
        function downloadSingleReportExcel(reportId) {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const report = reports.find(r => r.id === reportId);
            
            if (!report) {
                showToast('诏夭丕乇卮 丕鬲 卮丿', 'error');
                return;
            }

            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const reporterName = user.fullName || '丕卮禺氐';

            // 丨丕爻亘 爻丕毓丕鬲 讴丕乇
            let workHours = '丕卮禺氐';
            if (report.startTime && report.endTime) {
                try {
                    const start = new Date(`2000-01-01 ${report.startTime}`);
                    const end = new Date(`2000-01-01 ${report.endTime}`);
                    let hours = (end - start) / (1000 * 60 * 60);
                    if (hours < 0) hours += 24;
                    workHours = `${Math.round(hours * 10) / 10} 爻丕毓鬲`;
                } catch (error) {
                    workHours = '丕卮禺氐';
                }
            }
            
            const machineName = report.stoppedMachine === '丿诏乇' ? report.otherMachineName : report.stoppedMachine;
            const varietyName = report.varietyType === '丿诏乇' ? report.otherVarietyName : report.varietyType;
            
            const excelData = [{
                '诏夭丕乇卮 丿丿': reporterName,
                '卮丕乇 讴丕乇鬲': user.employeeId || '丕卮禺氐',
                '丕丿丕乇': report.office,
                '毓 讴卮鬲': report.cultivationType,
                '丕 倬丕讴丕乇': report.contractorName || '',
                '毓 丕乇鬲': varietyName || '',
                '丕 讴丕丕': report.canalName,
                '毓鬲 夭乇毓': report.farmLocation,
                '爻丕毓鬲 卮乇毓': report.startTime,
                '爻丕毓鬲 倬丕丕': report.endTime,
                '丿鬲 讴丕乇': workHours,
                '丿爻鬲诏丕 鬲': report.stoppedMachine || '丿丕乇丿',
                '丕 丿爻鬲诏丕': machineName || '',
                '爻丕毓鬲 卮乇毓 鬲': report.stopStartTime || '',
                '爻丕毓鬲 倬丕丕 鬲': report.stopEndTime || '',
                '丿 鬲': report.stopReason || '',
                '讴鬲丕乇 丕乇夭': report.todayHectares,
                '讴鬲丕乇 鬲丕 丕乇夭': report.totalHectares,
                '鬲丕乇禺 孬亘鬲': report.recordDate,
                '爻丕毓鬲 孬亘鬲': report.recordTime,
                '讴鬲': report.notes || ''
            }];

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '诏夭丕乇卮 乇夭丕');
            
            const fileName = `诏夭丕乇卮-${report.office}-${report.recordDate}-${reportId}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('丕 丕讴爻 诏夭丕乇卮 丿丕丿 卮丿');
        }

        // 丕卮 丕毓丕
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            else if (type === 'warning') bgColor = 'bg-orange-500';
            
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // 丿乇鬲 丕丨乇丕夭 鬲
        function checkAuth() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');
                initializeForm();
            } else {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('mainPage').classList.add('hidden');
            }
        }

        // 乇丿 讴丕乇亘乇
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const employeeId = document.getElementById('employeeId').value;
            const password = document.getElementById('password').value;
            
            if (password !== 'MK1370') {
                showToast('乇夭 乇丿 丕卮鬲亘丕 丕爻鬲', 'error');
                return;
            }
            
            const userData = {
                fullName: fullName,
                employeeId: employeeId,
                loginDate: new Date().toISOString()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(userData));
            
            // 匕禺乇 讴丕乇亘乇 丿乇 爻乇乇 丕亘乇
            try {
                await saveUserToCloud(userData);
            } catch (error) {
                console.log('禺胤丕 丿乇 匕禺乇 讴丕乇亘乇 丿乇 爻乇乇:', error);
            }
            
            showToast('乇丿 鬲丌17 亘丿');
            checkAuth();
            
            // 诏丕爻丕夭17 禺丿讴丕乇 诏夭丕乇卮丕17 讴丕乇亘乇 倬爻 丕夭 乇丿
            setTimeout(async () => {
                try {
                    const result = await syncUserReportsWithCloud(employeeId);
                    if (result.success && result.newReports > 0) {
                        calculateTotalHectares();
                        showToast(`锔 ${result.newReports} 诏夭丕乇卮 丕夭 爻乇乇 丿乇丕鬲 卮丿`);
                    }
                } catch (error) {
                    console.log('诏丕爻丕夭17 禺丿讴丕乇 丕噩丕 卮丿:', error);
                }
            }, 2000);
        });

        // 禺乇噩 讴丕乇亘乇
        function logout() {
            localStorage.removeItem('currentUser');
            closeSidebar();
            checkAuth();
            showToast('禺乇噩 鬲丌17 亘丿');
        }

        // 丿乇鬲  讴丕乇
        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').classList.add('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
        }

        // 丕卮 氐丨丕鬲 
        function showUserInfo() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                showToast('丕胤丕毓丕鬲 讴丕乇亘乇 丕鬲 卮丿', 'error');
                return;
            }
            
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const totalHectares = reports.reduce((sum, report) => sum + parseFloat(report.todayHectares || 0), 0);
            const content = document.getElementById('userInfoContent');
            
            content.innerHTML = `
                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl border border-green-200">
                    <div class="flex items-center mb-6">
                        <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-700 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                            ${user.fullName ? user.fullName.charAt(0) : '讴'}
                        </div>
                        <div class="mr-4">
                            <h3 class="text-xl font-bold text-gray-800">${user.fullName || '丕卮禺氐'}</h3>
                            <p class="text-gray-600 font-medium"> 讴丕乇鬲 倬乇爻: ${user.employeeId || '丕卮禺氐'}</p>
                            <p class="text-sm text-green-600 font-medium">17 讴丕乇亘乇 毓丕</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <div class="text-xs text-gray-500 mb-1">鬲丕乇禺 乇丿</div>
                            <div class="text-sm font-medium text-gray-800">
                                ${user.loginDate ? toPersianDate(new Date(user.loginDate)) : '丕卮禺氐'}
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm">
                            <div class="text-xs text-gray-500 mb-1">爻丕毓鬲 乇丿</div>
                            <div class="text-sm font-medium text-gray-800">
                                ${user.loginDate ? new Date(user.loginDate).toLocaleTimeString('fa-IR', {hour: '2-digit', minute: '2-digit'}) : '丕卮禺氐'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 space-y-4">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                             丌丕乇 毓讴乇丿 卮丕
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">${reports.length}</div>
                                <div class="text-xs text-gray-600">鬲毓丿丕丿 诏夭丕乇卮17</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${totalHectares.toFixed(1)}</div>
                                <div class="text-xs text-gray-600">讴 讴鬲丕乇 讴卮鬲</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 mb-2"> 囟毓鬲 毓讴乇丿</h4>
                        <div class="text-sm text-yellow-700">
                            ${reports.length > 10 ? '毓讴乇丿 毓丕! 亘卮 丕夭 10 诏夭丕乇卮 孬亘鬲 卮丿' : 
                              reports.length > 5 ? '毓讴乇丿 禺亘! 丕丿丕 丿丿' : 
                              reports.length > 0 ? '卮乇毓 禺亘 丿丕卮鬲丕17' : '夭 诏夭丕乇卮 孬亘鬲 讴乇丿丕17'}
                        </div>
                    </div>
                </div>
            `;
            
            hideAllPages();
            document.getElementById('menuPages').classList.remove('hidden');
            document.getElementById('userInfoPage').classList.remove('hidden');
            closeSidebar();
        }

        function showPerformance() {
            hideAllPages();
            document.getElementById('menuPages').classList.remove('hidden');
            document.getElementById('performancePage').classList.remove('hidden');
            closeSidebar();
            
            // 鬲丕禺乇 讴鬲丕 亘乇丕 丕胤丕 丕夭 丕卮 氐丨
            setTimeout(() => {
                generateCharts();
            }, 500);
        }

        function showSupport() {
            hideAllPages();
            document.getElementById('menuPages').classList.remove('hidden');
            document.getElementById('supportPage').classList.remove('hidden');
            closeSidebar();
        }

        function showBackup() {
            hideAllPages();
            document.getElementById('menuPages').classList.remove('hidden');
            document.getElementById('backupPage').classList.remove('hidden');
            closeSidebar();
            
            // 亘乇夭乇爻丕17 丕胤丕毓丕鬲 毓
            updateBackupInfo();
        }
        
        function updateBackupInfo() {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const totalHectares = reports.reduce((sum, report) => sum + parseFloat(report.todayHectares || 0), 0);
            
            const reportsCountEl = document.getElementById('currentReportsCount');
            const totalHectaresEl = document.getElementById('currentTotalHectares');
            
            if (reportsCountEl) reportsCountEl.textContent = reports.length;
            if (totalHectaresEl) totalHectaresEl.textContent = totalHectares.toFixed(1);
        }

        function backToMain() {
            hideAllPages();
            document.getElementById('mainPage').classList.remove('hidden');
        }

        function hideAllPages() {
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('menuPages').classList.add('hidden');
            document.getElementById('userInfoPage').classList.add('hidden');
            document.getElementById('performancePage').classList.add('hidden');
            document.getElementById('supportPage').classList.add('hidden');
            document.getElementById('backupPage').classList.add('hidden');
        }

        // 鬲丕爻 亘丕 倬卮鬲亘丕
        function callSupport() {
            const phoneNumber = '09168231334';
            const confirmMessage = `丌丕 禺丕17 亘丕 卮丕乇 倬卮鬲亘丕 鬲丕爻 亘诏乇丿\n\n ${phoneNumber}\n 丨丿 讴毓亘`;
            
            if (confirm(confirmMessage)) {
                window.location.href = `tel:${phoneNumber}`;
                showToast('丿乇 丨丕 亘乇乇丕乇 鬲丕爻...');
            }
        }

        // 鬲丿 丿丕乇丕
        function generateCharts() {
            const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
            const performanceContent = document.getElementById('performanceContent');
            
            if (reports.length === 0) {
                performanceContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-8xl mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-700 mb-3">夭 诏夭丕乇卮 孬亘鬲 卮丿</h3>
                        <p class="text-gray-500 mb-6">亘乇丕 卮丕丿 丿丕乇丕 毓讴乇丿 丕亘鬲丿丕 诏夭丕乇卮丕17 孬亘鬲 讴丿</p>
                        <button onclick="backToMain()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium">
                             孬亘鬲 诏夭丕乇卮 噩丿丿
                        </button>
                    </div>
                `;
                return;
            }
            
            // 亘丕夭爻丕夭 丨鬲丕 丿丕乇丕
            performanceContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                        <h3 class="text-lg font-bold mb-4 text-center text-green-800"> 乇丿 讴卮鬲 讴鬲丕乇</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="hectareChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                        <h3 class="text-lg font-bold mb-4 text-center text-blue-800">17 爻丕毓丕鬲 讴丕乇 乇夭丕</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="hoursChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                        <h3 class="text-lg font-bold mb-4 text-center text-purple-800"> 禺丕氐 丌丕乇</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600">${reports.reduce((sum, r) => sum + parseFloat(r.todayHectares || 0), 0).toFixed(1)}</div>
                                <div class="text-sm text-gray-600">讴 讴鬲丕乇</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600">${reports.length}</div>
                                <div class="text-sm text-gray-600">鬲毓丿丕丿 诏夭丕乇卮</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 鬲丕禺乇 讴鬲丕 亘乇丕 丕胤丕 丕夭 乇丿乇 卮丿 毓丕氐乇
            setTimeout(() => {
                try {
                    // 倬丕讴 讴乇丿 丿丕乇丕 亘
                    if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                        window.hectareChart.destroy();
                        window.hectareChart = null;
                    }
                    if (window.hoursChart && typeof window.hoursChart.destroy === 'function') {
                        window.hoursChart.destroy();
                        window.hoursChart = null;
                    }
                    
                    // 丿丕乇 讴鬲丕乇
                    const hectareCanvas = document.getElementById('hectareChart');
                    if (hectareCanvas && hectareCanvas.getContext) {
                        const hectareCtx = hectareCanvas.getContext('2d');
                        if (!hectareCtx) {
                            console.error('鬲丕17 context 丿丕乇 讴鬲丕乇 乇丕 丿乇丕鬲 讴乇丿');
                            return;
                        }
                        const hectareData = processHectareData(reports);
                        
                        window.hectareChart = new Chart(hectareCtx, {
                            type: 'line',
                            data: {
                                labels: hectareData.labels,
                                datasets: [{
                                    label: '讴鬲丕乇 讴卮鬲 卮丿',
                                    data: hectareData.values,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                    tension: 0.4,
                                    fill: true,
                                    pointBackgroundColor: 'rgb(34, 197, 94)',
                                    pointBorderColor: 'white',
                                    pointBorderWidth: 2,
                                    pointRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '讴鬲丕乇',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0,0,0,0.1)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: '鬲丕乇禺',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0,0,0,0.1)'
                                        }
                                    }
                                }
                            }
                        });
                    }

                    // 丿丕乇 爻丕毓丕鬲 讴丕乇
                    const hoursCanvas = document.getElementById('hoursChart');
                    if (hoursCanvas && hoursCanvas.getContext) {
                        const hoursCtx = hoursCanvas.getContext('2d');
                        if (!hoursCtx) {
                            console.error('鬲丕17 context 丿丕乇 爻丕毓丕鬲 乇丕 丿乇丕鬲 讴乇丿');
                            return;
                        }
                        const hoursData = processHoursData(reports);
                        
                        window.hoursChart = new Chart(hoursCtx, {
                            type: 'bar',
                            data: {
                                labels: hoursData.labels,
                                datasets: [{
                                    label: '爻丕毓丕鬲 讴丕乇',
                                    data: hoursData.values,
                                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                    borderColor: 'rgb(59, 130, 246)',
                                    borderWidth: 2,
                                    borderRadius: 8,
                                    borderSkipped: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: '爻丕毓鬲',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0,0,0,0.1)'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: '鬲丕乇禺',
                                            font: {
                                                size: 14,
                                                weight: 'bold'
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0,0,0,0.1)'
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('禺胤丕 丿乇 丕噩丕丿 丿丕乇丕:', error);
                    performanceContent.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">锔</div>
                            <h3 class="text-lg font-semibold text-red-600 mb-2">禺胤丕 丿乇 丕卮 丿丕乇丕</h3>
                            <p class="text-gray-500">胤丕 噩丿丿丕 鬲丕卮 讴丿</p>
                            <button onclick="generateCharts()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                                 鬲丕卮 噩丿丿
                            </button>
                        </div>
                    `;
                }
            }, 300);
        }

        function processHectareData(reports) {
            const dailyData = {};
            const officeData = {};
            
            reports.forEach(report => {
                const date = report.recordDate || '丕卮禺氐';
                const office = report.office || '丕卮禺氐';
                const hectares = parseFloat(report.todayHectares || 0);
                
                // 丿丕丿丕17 讴
                if (!dailyData[date]) {
                    dailyData[date] = 0;
                }
                dailyData[date] += hectares;
                
                // 丿丕丿丕17 乇 丕丿丕乇
                if (!officeData[office]) {
                    officeData[office] = {};
                }
                if (!officeData[office][date]) {
                    officeData[office][date] = 0;
                }
                officeData[office][date] += hectares;
            });
            
            // 乇鬲亘 讴乇丿 鬲丕乇禺17
            const sortedDates = Object.keys(dailyData).sort();
            
            return {
                labels: sortedDates,
                values: sortedDates.map(date => dailyData[date]),
                officeData: officeData
            };
        }

        function processHoursData(reports) {
            const dailyHours = {};
            const officeHours = {};
            
            reports.forEach(report => {
                const date = report.recordDate || '丕卮禺氐';
                const office = report.office || '丕卮禺氐';
                
                if (report.startTime && report.endTime) {
                    try {
                        const start = new Date(`2000-01-01 ${report.startTime}`);
                        const end = new Date(`2000-01-01 ${report.endTime}`);
                        let hours = (end - start) / (1000 * 60 * 60);
                        
                        // 丕诏乇 爻丕毓鬲 倬丕丕 讴鬲乇 丕夭 卮乇毓 亘丕卮丿 (卮亘 讴丕乇)
                        if (hours < 0) {
                            hours += 24;
                        }
                        
                        // 丿丕丿丕17 讴
                        if (!dailyHours[date]) {
                            dailyHours[date] = 0;
                        }
                        dailyHours[date] += hours;
                        
                        // 丿丕丿丕17 乇 丕丿丕乇
                        if (!officeHours[office]) {
                            officeHours[office] = {};
                        }
                        if (!officeHours[office][date]) {
                            officeHours[office][date] = 0;
                        }
                        officeHours[office][date] += hours;
                    } catch (error) {
                        console.log('禺胤丕 丿乇 丨丕爻亘 爻丕毓丕鬲:', error);
                    }
                }
            });
            
            // 乇鬲亘 讴乇丿 鬲丕乇禺17
            const sortedDates = Object.keys(dailyHours).sort();
            
            return {
                labels: sortedDates,
                values: sortedDates.map(date => Math.round(dailyHours[date] * 10) / 10),
                officeData: officeHours
            };
        }

        // 亘讴丕倬  亘丕夭丕亘
        function createBackup() {
            try {
                const reports = JSON.parse(localStorage.getItem('farmReports') || '[]');
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                const allData = {
                    user: user,
                    reports: reports,
                    backupDate: new Date().toISOString(),
                    version: '1.0',
                    totalReports: reports.length,
                    totalHectares: reports.reduce((sum, report) => sum + parseFloat(report.todayHectares || 0), 0)
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                const fileName = `讴卮丕乇夭-亘讴丕倬-${new Date().toISOString().split('T')[0]}.json`;
                link.download = fileName;
                link.click();
                
                showToast(`丕 亘讴丕倬 亘丕 ${reports.length} 诏夭丕乇卮 丕噩丕丿 卮丿`);
                
                // 倬丕讴 讴乇丿 URL 亘乇丕 丌夭丕丿爻丕夭 丨丕馗
                setTimeout(() => {
                    URL.revokeObjectURL(link.href);
                }, 100);
                
            } catch (error) {
                console.error('禺胤丕 丿乇 丕噩丕丿 亘讴丕倬:', error);
                showToast('禺胤丕 丿乇 丕噩丕丿 丕 亘讴丕倬', 'error');
            }
        }

        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('胤丕 丕 亘讴丕倬 乇丕 丕鬲禺丕亘 讴丿', 'error');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                showToast('胤丕 丕 JSON 毓鬲亘乇 丕鬲禺丕亘 讴丿', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // 亘乇乇爻 氐丨鬲 丕 亘讴丕倬
                    if (!backupData.reports || !Array.isArray(backupData.reports)) {
                        showToast('丕 亘讴丕倬 毓鬲亘乇 爻鬲', 'error');
                        return;
                    }
                    
                    // 鬲兀丿 亘丕夭丕亘
                    const currentReports = JSON.parse(localStorage.getItem('farmReports') || '[]');
                    const confirmMessage = `丌丕 胤卅 爻鬲丿\n\n丕胤丕毓丕鬲 毓: ${currentReports.length} 诏夭丕乇卮\n丕胤丕毓丕鬲 亘讴丕倬: ${backupData.reports.length} 诏夭丕乇卮\n\n鬲丕 丕胤丕毓丕鬲 毓 丨匕  噩丕诏夭 卮17.`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // 亘丕夭丕亘 丕胤丕毓丕鬲
                    if (backupData.user && Object.keys(backupData.user).length > 0) {
                        localStorage.setItem('currentUser', JSON.stringify(backupData.user));
                    }
                    
                    localStorage.setItem('farmReports', JSON.stringify(backupData.reports));
                    
                    showToast(`亘丕夭丕亘 : ${backupData.reports.length} 诏夭丕乇卮 亘丕夭丕亘 卮丿`);
                    
                    // 亘乇夭乇爻丕17 氐丨
                    calculateTotalHectares();
                    updateBackupInfo();
                    
                    // 倬丕讴 讴乇丿 丿 丕鬲禺丕亘 丕
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('禺胤丕 丿乇 亘丕夭丕亘:', error);
                    showToast('丕 亘讴丕倬 丌爻亘 丿丿 丕 丕毓鬲亘乇 丕爻鬲', 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('禺胤丕 丿乇 禺丕丿 丕', 'error');
            };
            
            reader.readAsText(file);
        }

        // 乇丕丕丿丕夭17 诏丕 亘丕乇诏匕丕乇 氐丨
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            updateConnectionStatus();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973ff9eca129cb47',t:'MTc1NjAwODM3OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
